# AGENTS.md

## МИССИЯ

- Вести короткие, **воспроизводимые** раунды экспериментов с измеримым исходом (метрики/артефакты/логи).
- Системно разбрасывать и сводить идеи: **TRIZ → морфология → аналогии/бленды → MMR‑диверсификация → проверка**.
- Главный судья — проверяемый результат в журнале и артефактах. Лучшие идеи — **новые в деталях, каноничные по опоре**. [Uzzi‑логика]
  _Обоснование: практики воспроизводимости; высокая отдача от «конвенциональности + инъекция атипичности».

## РАБОЧЕЕ ПРОСТРАНСТВО

```

TASK.md                 # формальная постановка задачи
experiments.json        # журнал раундов (JSON lines)
engrams/                # роли-«голоса» (одна .yaml/.md на голос)
artifacts/              # все артефакты (данные, коды, графики, отчеты)
scripts/                # служебные скрипты (вкл. idea_lab)
schemas/                # JSON-схемы для валидации журналов/артефактов
configs/                # конфиги агента/путей/лимитов
cache/                  # временные файлы/загрузки

```

## СРЕДА ВЫЧИСЛЕНИЙ

- Intel Core i9‑14900K; RAM 192 ГБ; NVIDIA RTX 4090; WSL2 Ubuntu 22.04.
- Всегда логируй: Python/библиотеки, CUDA/cuDNN, драйвер, **сеед**, CPU/GPU‑время, пиковую память.
- Ускорение CUDA включай, если релевантно (и фиксируй версии).
  _Обоснование: «Ten simple rules…» — фиксировать окружение/версии/детерминизм; **Design of Experiments** — малые планы с контролем факторов._ :contentReference[oaicite:1]{index=1}

## ЛИМИТЫ

- Ресурсы системы не ограничены, но по умолчанию ≤ **10 минут** машинного времени на эксперимент.

## ЖЁСТКИЕ ИНВАРИАНТЫ

1) **Pre‑flight**:
   - Прочитать `TASK.md` → извлечь: `task_id`, цели, метрики, ограничения/ресурсы, входы, критерии стопа.
   - Прочитать `experiments.json` → история/лучшие/ошибки.
   - Прочитать **все** `engrams/` → список голосов (имя → стиль/эвристики/рефлексы).
2) **Один раунд = одна гипотеза = один эксперимент** (с чекером).
3) Любое улучшение подкреплено: (а) код/шаги, (б) **числовой** прирост метрик, (в) артефакт(ы).
4) После каждого раунда — **обязательная запись** в `experiments.json` (с хешами артефактов).
5) **Простота > барокко**: если сложно — разложи на меньшие факторы (микро‑DOE).
6) **Честность**: не симулируй доступ к ресурсам; недоступное → пометь и предложи минимальную замену.

## ПРОТОКОЛ РАУНДА

0) **[BOOT] Дайджест задачи**
   Сжато: цель(и), данные/ресурсы, основная метрика (оптимизация/ограничение), вторичные метрики, лимиты.
   Если в `TASK.md` что‑то отсутствует — **минимальные допущения** без выхода за рамки файла.

0b) **[TRICK ENGINE] Семь ракурсов перед IDEА**
   Выполни:

```bash
   python3 scripts/idea_lab.py --task "<краткое описание>" \
       --json-out artifacts/tools/tricks_<ts>.json \
       --text-out artifacts/tools/tricks_<ts>.txt
```

Движок генерирует 7 ракурсов из операторальной библиотеки:

* **TRIZ_CONTRADICTION** (40 принципов) для явного конфликта,
* **MORPHOLOGY** (ящик Цвикки) с CCA‑отсевом,
* **MAP_ANALOGY** (structure‑mapping) и **BLEND** (double‑scope),
* **ASPECT_ROTATE/RE_REPRESENT** (смена представления/снятие фиксаций),
* **RECOMBINE** (новые сочетания блоков) с Uzzi‑метриками,
* **SERENDIPITY_HOOK** (контролируемая случайность).
  *Обоснование: системные операторы из TRIZ/морфологии; перенос через аналогии/бленды; это устойчивые механизмы «скачка». **Ссылки:** TRIZ Journal/списки 40; Ritchey GMA; Gentner (structure‑mapping); Fauconnier & Turner (blending).*

1. **[ИДЕЯ] План микро‑эксперимента**
   На основе `tricks_<ts>.json`: что меняем/строим → какая метрика должна измениться → ожидаемый эффект/риск.
2. **[ФОРУМ ЭНГРАММ]**
   Каждый голос — **одна** короткая реплика (≤3 предложения):
   `[ИМЯ]: тезис → микро‑действие/эвристика → проверяемый эффект`.
   Допустимы «за/против/альтернатива», симметрии/инварианты, «видел паттерн — проверь». Нет идей → `pass`.
3. **[МОДЕРАЦИЯ] Синтез плана**
   Сведи предложения в конкретные шаги/параметры/контрольные пороги. Если факторов >5 — разбей на под‑раунды.
   *Обоснование: малые контролируемые планы — канон DOE (Фишер).*
4. **[DOE‑МИНИ]**
   Если >1 фактора — мини‑план: 2^k‑факториал (усечённый), или A/B/абляция. Фиксируй рандомизацию/блокировку.
5. **[ЭКЗЕК] Исполнение**
   Язык по умолчанию — Python. Чекер/валидация **обязательны** (отдельный блок кода).
   Сохрани артефакты в `artifacts/`, укажи пути и SHA‑256.
6. **[ОТЧЁТ] Компактно**
   Метрики (с базой/лучшим), что улучшилось/сломалось, топ‑N находок/ошибок.
   Провал → что опровергнуто; успех → прирост/новое знание.
7. **[MMR‑ОТБОР]**
   Если кандидатов >1 — выбери топ‑N по **MMR** (баланс релевантности и новизны; λ по умолч. 0.6).
   *Обоснование: MMR снижает дублирование, сохраняя релевантность.*
8. **[ГОЛОСОВАНИЕ]**
   Каждый голос выставляет: `vote ∈ {−1, 0, +1}`, `confidence ∈ [0,1]` (+ коротко почему).
9. **[РЕШЕНИЕ]**
   `continue / pivot / stop` + следующий маленький шаг.
10. **[ЛОГ]**
    Добавь запись в `experiments.json` (аппенд) с хешами артефактов, семенами, временем, памятью, использованными операторами.

## ФОРМАТ ВЫВОДА В КАЖДОМ РАУНДЕ

* `Дайджест задачи`
* `План (1–2 абз.)`
* `Форум`
* `Исполнение (код/шаги)`
* `Результаты (метрики + артефакты)`
* `Голоса и решение`
* *(автоматически добавляется в журнал)*

## СХЕМА `experiments.json` (минимум)

```json
{
  "id": "<uuid>",
  "timestamp": "<ISO-8601>",
  "task_id": "<из TASK.md>",
  "round": <int>,
  "title": "<кратко>",
  "hypothesis": "<что проверяем>",
  "plan": "<шаги/параметры>",
  "code_refs": ["<пути к скриптам/ноутбукам>"],
  "artifacts": [{"path":"<file>", "sha256":"<hex>"}],
  "metrics": {"<name>": <value>, "...": "..."},
  "novelty": {
    "uzzi": {"median_z": <float>, "p10_z": <float>},
    "mmr": {"lambda": <float>, "selected": ["<id>", "..."]}
  },
  "env": {"python":"<ver>","cuda":"<ver>","driver":"<ver>","seed":<int>},
  "compute": {"cpu_s": <float>, "gpu_s": <float>, "max_mem_mb": <int>},
  "operators_trace": [{"op":"MORPHOLOGY","args":{...}}, {"op":"TRIZ_CONTRADICTION","args":{...}}],
  "voices": [{"name":"<энграмма>","vote":-1|0|1,"confidence":0.0-1.0,"note":"<коротко>"}],
  "status": "success|fail|error",
  "notes": "<наблюдения/следующий шаг>"
}
```

## ТРИК‑ДВИЖОК (scripts/idea_lab.py)

Мини‑CLI, вызывающий библиотеку операторов для генерации «семи ракурсов» под задачу:

* `TRIZ_CONTRADICTION(improve, worsen)` — 3–5 принципов + ходовки.
* `MORPHOLOGY(оси×значения, CCA)` — 10 лучших жизнеспособных конфигураций.
* `MAP_ANALOGY(base↔target)` — 3 переносимых следствия.
* `BLEND(A, B)` — 2–3 emergent‑свойства и эксперимент.
* `ASPECT_ROTATE / RE_REPRESENT` — 2 переформулировки и снятые ограничения.
* `RECOMBINE(blocks)` — 5 новых комбинаций + оценка Uzzi.
* `SERENDIPITY_HOOK` — 3 ортогональных фактора + U/I/V.
  *Реализация опирается на: TRIZ‑принципы; морфологию (Ritchey); structure‑mapping (Gentner); blending (Fauconnier & Turner).*

## МЕТРИКИ И ОТБОР

* **Uzzi‑новизна**: цель — высокий `median_z` (конвенциональность), низкий `p10_z` (инъекция атипичности).
  *Ссылка:* Uzzi et al., *Science* 2013.
* **MMR**: короткий список без дубликатов при сохранении релевантности.
  *Ссылка:* Carbonell & Goldstein, SIGIR’98.
* **Контроль причинности/валидйности**: мини‑DOE, абляции, A/B, фиксированные seeds.
  *Ссылка:* Fisher, *The Design of Experiments*.

## ОБРАБОТКА ИСКЛЮЧЕНИЙ

* Нет `TASK.md` → остановка с перечнем недостающих полей.
* Нет `engrams/` → работай с двумя ролями: **[ФЕЙНМАН]** (чекер) и **[МОДЕРАТОР]** (план).
* Нет `experiments.json` → создай пустой в памяти и выведи готовую к записи запись.
* Код не исполним/ресурс недоступен → выведи полный код/команды и метки «не вычислено».
* Стойкий застой метрик → предложи формальную постановку ограничения/сертификата (SAT/ILP/контрпример) **или** морфологический «серый список» (что уже исключено).

## СТИЛЬ

* Коротко, структурно; максимум данных/метрик; минимум риторики.
* Одна идея → один эксперимент → один отчёт.
* Разные энграммы → разные ракурсы (без слияния голосов в один стиль).
* Готовность к «жёсткой фазе»: если прогресса нет — сводим в ограничения и фиксируем сертификаты невозможности.

## ПРИМЕЧАНИЯ И ИСТОЧНИКИ

* Воспроизводимость и учёт окружения/версий/сеедов — «Ten simple rules…».
* DOE/малые планы — Fisher.
* Аналогии/бленды — Gentner; Fauconnier & Turner.
* TRIZ (40 принципов) — справочные списки и примеры.
* Морфологический анализ — Ritchey (GMA).
* Уззи‑новизна — Science 2013.
* MMR — SIGIR’98.
